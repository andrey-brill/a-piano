<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
	<title>A.Piano</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<script src="tone.js"></script>
</head>
<body>
	<script type="text/javascript">
        var tonesArray = ["A0", "C1", "D#1", "F#1", "A1", "C2", "D#2", "F#2", "A2", "C3", "D#3", "F#3", "A3", "C4", "D#4", "F#4", "A4", "C5", "D#5", "F#5", "A5", "C6", "D#6", "F#6", "A6", "C7", "D#7", "F#7", "A7", "C8"];


        var tones = {};
        for (var tone of tonesArray) {
            tones[tone] = 'c' + tone.replace('#', 's') + '.mp3';
        }

		var piano = new Tone.Sampler(tones, {
			"release" : 0.75,
			"curve": 'exponential',
			"baseUrl" : "./audio/"
		}).toDestination();

		const keysMapping = {

			q: 'F2',
			'2': 'F#2',
			w: 'G2',
			'3': 'G#2',
			e: 'A2',
			'4': 'A#2',
			r: 'B2',

			t: 'C3',
			'6': 'C#3',
			y: 'D3',
			'7': 'D#3',
			u: 'E3',

			i: 'F3',
			'9': 'F#3',
			o: 'G3',
			'0': 'G#3',
			p: 'A3',
			'-': 'A#3',
			'[': 'B3',

			']': 'C4'
		}
		const pressedKeys = {};

		window.addEventListener('keydown', function (e) {

            const { key } = e;

            e.preventDefault();

            console.log('onkeydown', key);

			const mapping = keysMapping[key];

			if (mapping && !pressedKeys[key]) {
				resume();

				console.log('onkeydown', key);
				pressedKeys[key] = true;

				piano.triggerAttack(mapping);
			}
		});

		window.addEventListener('keyup', function ({ key }) {

			if (pressedKeys[key]) {
				resume();

				pressedKeys[key] = false;
				console.log('keyup', key);

				piano.triggerRelease(keysMapping[key]);
			}
		});

		const silentAudio = 'data:audio/mp3;base64,//MkxAAHiAICWABElBeKPL/RANb2w+yiT1g/gTok//lP/W/l3h8QO/OCdCqCW2Cw//MkxAQHkAIWUAhEmAQXWUOFW2dxPu//9mr60ElY5sseQ+xxesmHKtZr7bsqqX2L//MkxAgFwAYiQAhEAC2hq22d3///9FTV6tA36JdgBJoOGgc+7qvqej5Zu7/7uI9l//MkxBQHAAYi8AhEAO193vt9KGOq+6qcT7hhfN5FTInmwk8RkqKImTM55pRQHQSq//MkxBsGkgoIAABHhTACIJLf99nVI///yuW1uBqWfEu7CgNPWGpUadBmZ////4sL//MkxCMHMAH9iABEmAsKioqKigsLCwtVTEFNRTMuOTkuNVVVVVVVVVVVVVVVVVVV//MkxCkECAUYCAAAAFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV'

		async function resume(){
			if (Tone.context.state === 'suspended'){
				const contextPromise = Tone.context.resume()

				//also play a silent audio file which unmutes iOS
				const audioElement = document.createElement('audio')
				audioElement.controls = false
				audioElement.preload = 'auto'
				audioElement.loop = false
				audioElement.src = silentAudio
				audioElement.title = 'Tone.js Examples'
				let elementPromise = Promise.resolve()
				try {
					elementPromise = await audioElement.play()
				} catch (e){
					elementPromise = Promise.resolve()
					console.log('did not start audio', e);
				}
				await Promise.all([elementPromise, contextPromise])
			}
		}

	</script>

</body>
</html>
